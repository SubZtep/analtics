var ce=Object.create,V=Object.defineProperty,le=Object.getPrototypeOf,he=Object.prototype.hasOwnProperty,de=Object.getOwnPropertyNames,pe=Object.getOwnPropertyDescriptor;var ye=t=>V(t,"__esModule",{value:!0});var W=(t,e)=>()=>(e||(e={exports:{}},t(e.exports,e)),e.exports);var ge=(t,e,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of de(e))!he.call(t,s)&&s!=="default"&&V(t,s,{get:()=>e[s],enumerable:!(r=pe(e,s))||r.enumerable});return t},me=t=>t&&t.__esModule?t:ge(ye(V(t!=null?ce(le(t)):{},"default",{value:t,enumerable:!0})),t);var _=W((Me,X)=>{"use strict";function we(t){if(!/^data:/i.test(t))throw new TypeError('`uri` does not appear to be a Data URI (must begin with "data:")');t=t.replace(/\r?\n/g,"");let e=t.indexOf(",");if(e===-1||e<=4)throw new TypeError("malformed data: URI");let r=t.substring(5,e).split(";"),s="",n=!1,o=r[0]||"text/plain",a=o;for(let l=1;l<r.length;l++)r[l]==="base64"?n=!0:(a+=`;${r[l]}`,r[l].indexOf("charset=")===0&&(s=r[l].substring(8)));!r[0]&&!s.length&&(a+=";charset=US-ASCII",s="US-ASCII");let i=n?"base64":"ascii",f=unescape(t.substring(e+1)),w=Buffer.from(f,i);return w.type=o,w.typeFull=a,w.charset=s,w}X.exports=we});var ee=W((De,j)=>{var{Readable:be}=require("stream"),z=new WeakMap;async function*Se(t){for(let e of t)"stream"in e?yield*e.stream():yield e}var C=class{constructor(e=[],r={type:""}){let s=0,n=e.map(a=>{let i;return a instanceof Buffer?i=a:ArrayBuffer.isView(a)?i=Buffer.from(a.buffer,a.byteOffset,a.byteLength):a instanceof ArrayBuffer?i=Buffer.from(a):a instanceof C?i=a:i=Buffer.from(typeof a=="string"?a:String(a)),s+=i.length||i.size||0,i}),o=r.type===void 0?"":String(r.type).toLowerCase();z.set(this,{type:/[^\u0020-\u007E]/.test(o)?"":o,size:s,parts:n})}get size(){return z.get(this).size}get type(){return z.get(this).type}async text(){return Buffer.from(await this.arrayBuffer()).toString()}async arrayBuffer(){let e=new Uint8Array(this.size),r=0;for await(let s of this.stream())e.set(s,r),r+=s.length;return e.buffer}stream(){return be.from(Se(z.get(this).parts))}slice(e=0,r=this.size,s=""){let{size:n}=this,o=e<0?Math.max(n+e,0):Math.min(e,n),a=r<0?Math.max(n+r,0):Math.min(r,n),i=Math.max(a-o,0),f=z.get(this).parts.values(),w=[],l=0;for(let y of f){let u=ArrayBuffer.isView(y)?y.byteLength:y.size;if(o&&u<=o)o-=u,a-=u;else{let g=y.slice(o,Math.min(u,a));if(w.push(g),l+=ArrayBuffer.isView(g)?g.byteLength:g.size,o=0,l>=i)break}}let L=new C([],{type:s});return Object.assign(z.get(L),{size:i,parts:w}),L}get[Symbol.toStringTag](){return"Blob"}static[Symbol.hasInstance](e){return typeof e=="object"&&typeof e.stream=="function"&&e.stream.length===0&&typeof e.constructor=="function"&&/^(Blob|File)$/.test(e[Symbol.toStringTag])}};Object.defineProperties(C.prototype,{size:{enumerable:!0},type:{enumerable:!0},slice:{enumerable:!0}});j.exports=C});var ie=W((B,te)=>{"use strict";B=te.exports=G;var k=require("http"),Te=require("https"),v=require("zlib"),c=require("stream"),Be=_(),F=require("util"),$e=ee(),Ee=require("crypto"),Le=require("url"),H=class extends Error{constructor(e,r){super(e);Error.captureStackTrace(this,this.constructor),this.type=r}get name(){return this.constructor.name}get[Symbol.toStringTag](){return this.constructor.name}},m=class extends H{constructor(e,r,s){super(e,r);s&&(this.code=this.errno=s.code,this.erroredSysCall=s.syscall)}},I=Symbol.toStringTag,re=t=>typeof t=="object"&&typeof t.append=="function"&&typeof t.delete=="function"&&typeof t.get=="function"&&typeof t.getAll=="function"&&typeof t.has=="function"&&typeof t.set=="function"&&typeof t.sort=="function"&&t[I]==="URLSearchParams",x=t=>typeof t=="object"&&typeof t.arrayBuffer=="function"&&typeof t.type=="string"&&typeof t.stream=="function"&&typeof t.constructor=="function"&&/^(Blob|File)$/.test(t[I]);function K(t){return typeof t=="object"&&typeof t.append=="function"&&typeof t.set=="function"&&typeof t.get=="function"&&typeof t.getAll=="function"&&typeof t.delete=="function"&&typeof t.keys=="function"&&typeof t.values=="function"&&typeof t.entries=="function"&&typeof t.constructor=="function"&&t[I]==="FormData"}var Ae=t=>typeof t=="object"&&t[I]==="AbortSignal",O=`\r
`,J="-".repeat(2),xe=Buffer.byteLength(O),ne=t=>`${J}${t}${J}${O.repeat(2)}`;function se(t,e,r){let s="";return s+=`${J}${t}${O}`,s+=`Content-Disposition: form-data; name="${e}"`,x(r)&&(s+=`; filename="${r.name}"${O}`,s+=`Content-Type: ${r.type||"application/octet-stream"}`),`${s}${O.repeat(2)}`}var Pe=()=>Ee.randomBytes(8).toString("hex");async function*Re(t,e){for(let[r,s]of t)yield se(e,r,s),x(s)?yield*s.stream():yield s,yield O;yield ne(e)}function ze(t,e){let r=0;for(let[s,n]of t)r+=Buffer.byteLength(se(e,s,n)),x(n)?r+=n.size:r+=Buffer.byteLength(String(n)),r+=xe;return r+=Buffer.byteLength(ne(e)),r}var d=Symbol("Body internals"),N=class{constructor(e,{size:r=0}={}){let s=null;e===null?e=null:re(e)?e=Buffer.from(e.toString()):x(e)||Buffer.isBuffer(e)||(F.types.isAnyArrayBuffer(e)?e=Buffer.from(e):ArrayBuffer.isView(e)?e=Buffer.from(e.buffer,e.byteOffset,e.byteLength):e instanceof c||(K(e)?(s=`NodeFetchFormDataBoundary${Pe()}`,e=c.Readable.from(Re(e,s))):e=Buffer.from(String(e)))),this[d]={body:e,boundary:s,disturbed:!1,error:null},this.size=r,e instanceof c&&e.on("error",n=>{let o=n instanceof H?n:new m(`Invalid response body while trying to fetch ${this.url}: ${n.message}`,"system",n);this[d].error=o})}get body(){return this[d].body}get bodyUsed(){return this[d].disturbed}async arrayBuffer(){let{buffer:e,byteOffset:r,byteLength:s}=await q(this);return e.slice(r,r+s)}async blob(){let e=this.headers&&this.headers.get("content-type")||this[d].body&&this[d].body.type||"",r=await this.buffer();return new $e([r],{type:e})}async json(){let e=await q(this);return JSON.parse(e.toString())}async text(){return(await q(this)).toString()}buffer(){return q(this)}};Object.defineProperties(N.prototype,{body:{enumerable:!0},bodyUsed:{enumerable:!0},arrayBuffer:{enumerable:!0},blob:{enumerable:!0},json:{enumerable:!0},text:{enumerable:!0}});async function q(t){if(t[d].disturbed)throw new TypeError(`body used already for: ${t.url}`);if(t[d].disturbed=!0,t[d].error)throw t[d].error;let{body:e}=t;if(e===null)return Buffer.alloc(0);if(x(e)&&(e=e.stream()),Buffer.isBuffer(e))return e;if(!(e instanceof c))return Buffer.alloc(0);let r=[],s=0;try{for await(let n of e){if(t.size>0&&s+n.length>t.size){let o=new m(`content size at ${t.url} over limit: ${t.size}`,"max-size");throw e.destroy(o),o}s+=n.length,r.push(n)}}catch(n){throw n instanceof H?n:new m(`Invalid response body while trying to fetch ${t.url}: ${n.message}`,"system",n)}if(e.readableEnded===!0||e._readableState.ended===!0)try{return r.every(n=>typeof n=="string")?Buffer.from(r.join("")):Buffer.concat(r,s)}catch(n){throw new m(`Could not create Buffer from response body for ${t.url}: ${n.message}`,"system",n)}else throw new m(`Premature close of server response while trying to fetch ${t.url}`)}var oe=(t,e)=>{let r,s,{body:n}=t;if(t.bodyUsed)throw new Error("cannot clone body after it is used");return n instanceof c&&typeof n.getBoundary!="function"&&(r=new c.PassThrough({highWaterMark:e}),s=new c.PassThrough({highWaterMark:e}),n.pipe(r),n.pipe(s),t[d].body=r,n=s),n},ae=(t,e)=>t===null?null:typeof t=="string"?"text/plain;charset=UTF-8":re(t)?"application/x-www-form-urlencoded;charset=UTF-8":x(t)?t.type||null:Buffer.isBuffer(t)||F.types.isAnyArrayBuffer(t)||ArrayBuffer.isView(t)?null:t&&typeof t.getBoundary=="function"?`multipart/form-data;boundary=${t.getBoundary()}`:K(t)?`multipart/form-data; boundary=${e[d].boundary}`:t instanceof c?null:"text/plain;charset=UTF-8",Ce=t=>{let{body:e}=t;return e===null?0:x(e)?e.size:Buffer.isBuffer(e)?e.length:e&&typeof e.getLengthSync=="function"?e.hasKnownLength&&e.hasKnownLength()?e.getLengthSync():null:K(e)?ze(t[d].boundary):null},ve=(t,{body:e})=>{e===null?t.end():x(e)?e.stream().pipe(t):Buffer.isBuffer(e)?(t.write(e),t.end()):e.pipe(t)},M=typeof k.validateHeaderName=="function"?k.validateHeaderName:t=>{if(!/^[\^`\-\w!#$%&'*+.|~]+$/.test(t)){let e=new TypeError(`Header name must be a valid HTTP token [${t}]`);throw Object.defineProperty(e,"code",{value:"ERR_INVALID_HTTP_TOKEN"}),e}},Q=typeof k.validateHeaderValue=="function"?k.validateHeaderValue:(t,e)=>{if(/[^\t\u0020-\u007E\u0080-\u00FF]/.test(e)){let r=new TypeError(`Invalid character in header content ["${t}"]`);throw Object.defineProperty(r,"code",{value:"ERR_INVALID_CHAR"}),r}},S=class extends URLSearchParams{constructor(e){let r=[];if(e instanceof S){let s=e.raw();for(let[n,o]of Object.entries(s))r.push(...o.map(a=>[n,a]))}else if(e!=null)if(typeof e=="object"&&!F.types.isBoxedPrimitive(e)){let s=e[Symbol.iterator];if(s==null)r.push(...Object.entries(e));else{if(typeof s!="function")throw new TypeError("Header pairs must be iterable");r=[...e].map(n=>{if(typeof n!="object"||F.types.isBoxedPrimitive(n))throw new TypeError("Each header pair must be an iterable object");return[...n]}).map(n=>{if(n.length!==2)throw new TypeError("Each header pair must be a name/value tuple");return[...n]})}}else throw new TypeError("Failed to construct 'Headers': The provided value is not of type '(sequence<sequence<ByteString>> or record<ByteString, ByteString>)");return r=r.length>0?r.map(([s,n])=>(M(s),Q(s,String(n)),[String(s).toLowerCase(),String(n)])):void 0,super(r),new Proxy(this,{get(s,n,o){switch(n){case"append":case"set":return(a,i)=>(M(a),Q(a,String(i)),URLSearchParams.prototype[n].call(o,String(a).toLowerCase(),String(i)));case"delete":case"has":case"getAll":return a=>(M(a),URLSearchParams.prototype[n].call(o,String(a).toLowerCase()));case"keys":return()=>(s.sort(),new Set(URLSearchParams.prototype.keys.call(s)).keys());default:return Reflect.get(s,n,o)}}})}get[Symbol.toStringTag](){return this.constructor.name}toString(){return Object.prototype.toString.call(this)}get(e){let r=this.getAll(e);if(r.length===0)return null;let s=r.join(", ");return/^content-encoding$/i.test(e)&&(s=s.toLowerCase()),s}forEach(e){for(let r of this.keys())e(this.get(r),r)}*values(){for(let e of this.keys())yield this.get(e)}*entries(){for(let e of this.keys())yield[e,this.get(e)]}[Symbol.iterator](){return this.entries()}raw(){return[...this.keys()].reduce((e,r)=>(e[r]=this.getAll(r),e),{})}[Symbol.for("nodejs.util.inspect.custom")](){return[...this.keys()].reduce((e,r)=>{let s=this.getAll(r);return r==="host"?e[r]=s[0]:e[r]=s.length>1?s:s[0],e},{})}};Object.defineProperties(S.prototype,["get","entries","forEach","values"].reduce((t,e)=>(t[e]={enumerable:!0},t),{}));function Oe(t=[]){return new S(t.reduce((e,r,s,n)=>(s%2==0&&e.push(n.slice(s,s+2)),e),[]).filter(([e,r])=>{try{return M(e),Q(e,String(r)),!0}catch{return!1}}))}var Ue=new Set([301,302,303,307,308]),Y=t=>Ue.has(t),$=Symbol("Response internals"),p=class extends N{constructor(e=null,r={}){super(e,r);let s=r.status||200,n=new S(r.headers);if(e!==null&&!n.has("Content-Type")){let o=ae(e);o&&n.append("Content-Type",o)}this[$]={url:r.url,status:s,statusText:r.statusText||"",headers:n,counter:r.counter,highWaterMark:r.highWaterMark}}get url(){return this[$].url||""}get status(){return this[$].status}get ok(){return this[$].status>=200&&this[$].status<300}get redirected(){return this[$].counter>0}get statusText(){return this[$].statusText}get headers(){return this[$].headers}get highWaterMark(){return this[$].highWaterMark}clone(){return new p(oe(this,this.highWaterMark),{url:this.url,status:this.status,statusText:this.statusText,headers:this.headers,ok:this.ok,redirected:this.redirected,size:this.size})}static redirect(e,r=302){if(!Y(r))throw new RangeError('Failed to execute "redirect" on "response": Invalid status code');return new p(null,{headers:{location:new URL(e).toString()},status:r})}get[Symbol.toStringTag](){return"Response"}};Object.defineProperties(p.prototype,{url:{enumerable:!0},status:{enumerable:!0},ok:{enumerable:!0},redirected:{enumerable:!0},statusText:{enumerable:!0},headers:{enumerable:!0},clone:{enumerable:!0}});var ke=t=>{if(t.search)return t.search;let e=t.href.length-1,r=t.hash||(t.href[e]==="#"?"#":"");return t.href[e-r.length]==="?"?"?":""},E=Symbol("Request internals"),D=t=>typeof t=="object"&&typeof t[E]=="object",P=class extends N{constructor(e,r={}){let s;D(e)?s=new URL(e.url):(s=new URL(e),e={});let n=r.method||e.method||"GET";if(n=n.toUpperCase(),(r.body!=null||D(e))&&e.body!==null&&(n==="GET"||n==="HEAD"))throw new TypeError("Request with GET/HEAD method cannot have body");let o=r.body?r.body:D(e)&&e.body!==null?oe(e):null;super(o,{size:r.size||e.size||0});let a=new S(r.headers||e.headers||{});if(o!==null&&!a.has("Content-Type")){let f=ae(o,this);f&&a.append("Content-Type",f)}let i=D(e)?e.signal:null;if("signal"in r&&(i=r.signal),i!==null&&!Ae(i))throw new TypeError("Expected signal to be an instanceof AbortSignal");this[E]={method:n,redirect:r.redirect||e.redirect||"follow",headers:a,parsedURL:s,signal:i},this.follow=r.follow===void 0?e.follow===void 0?20:e.follow:r.follow,this.compress=r.compress===void 0?e.compress===void 0?!0:e.compress:r.compress,this.counter=r.counter||e.counter||0,this.agent=r.agent||e.agent,this.highWaterMark=r.highWaterMark||e.highWaterMark||16384,this.insecureHTTPParser=r.insecureHTTPParser||e.insecureHTTPParser||!1}get method(){return this[E].method}get url(){return Le.format(this[E].parsedURL)}get headers(){return this[E].headers}get redirect(){return this[E].redirect}get signal(){return this[E].signal}clone(){return new P(this)}get[Symbol.toStringTag](){return"Request"}};Object.defineProperties(P.prototype,{method:{enumerable:!0},url:{enumerable:!0},headers:{enumerable:!0},redirect:{enumerable:!0},clone:{enumerable:!0},signal:{enumerable:!0}});var He=t=>{let{parsedURL:e}=t[E],r=new S(t[E].headers);r.has("Accept")||r.set("Accept","*/*");let s=null;if(t.body===null&&/^(post|put)$/i.test(t.method)&&(s="0"),t.body!==null){let i=Ce(t);typeof i=="number"&&!Number.isNaN(i)&&(s=String(i))}s&&r.set("Content-Length",s),r.has("User-Agent")||r.set("User-Agent","node-fetch"),t.compress&&!r.has("Accept-Encoding")&&r.set("Accept-Encoding","gzip,deflate,br");let{agent:n}=t;typeof n=="function"&&(n=n(e)),!r.has("Connection")&&!n&&r.set("Connection","close");let o=ke(e);return{path:e.pathname+o,pathname:e.pathname,hostname:e.hostname,protocol:e.protocol,port:e.port,hash:e.hash,search:e.search,query:e.query,href:e.href,method:t.method,headers:r[Symbol.for("nodejs.util.inspect.custom")](),insecureHTTPParser:t.insecureHTTPParser,agent:n}},Z=class extends H{constructor(e,r="aborted"){super(e,r)}},Fe=new Set(["data:","http:","https:"]);async function G(t,e){return new Promise((r,s)=>{let n=new P(t,e),o=He(n);if(!Fe.has(o.protocol))throw new TypeError(`node-fetch cannot load ${t}. URL scheme "${o.protocol.replace(/:$/,"")}" is not supported.`);if(o.protocol==="data:"){let u=Be(n.url),g=new p(u,{headers:{"Content-Type":u.typeFull}});r(g);return}let a=(o.protocol==="https:"?Te:k).request,{signal:i}=n,f=null,w=()=>{let u=new Z("The operation was aborted.");s(u),n.body&&n.body instanceof c.Readable&&n.body.destroy(u),!(!f||!f.body)&&f.body.emit("error",u)};if(i&&i.aborted){w();return}let l=()=>{w(),y()},L=a(o);i&&i.addEventListener("abort",l);let y=()=>{L.abort(),i&&i.removeEventListener("abort",l)};L.on("error",u=>{s(new m(`request to ${n.url} failed, reason: ${u.message}`,"system",u)),y()}),L.on("response",u=>{L.setTimeout(0);let g=Oe(u.rawHeaders);if(Y(u.statusCode)){let T=g.get("Location"),A=T===null?null:new URL(T,n.url);switch(n.redirect){case"error":s(new m(`uri requested responds with a redirect, redirect mode is set to error: ${n.url}`,"no-redirect")),y();return;case"manual":if(A!==null)try{g.set("Location",A)}catch(b){s(b)}break;case"follow":{if(A===null)break;if(n.counter>=n.follow){s(new m(`maximum redirect reached at: ${n.url}`,"max-redirect")),y();return}let b={headers:new S(n.headers),follow:n.follow,counter:n.counter+1,agent:n.agent,compress:n.compress,method:n.method,body:n.body,signal:n.signal,size:n.size};if(u.statusCode!==303&&n.body&&e.body instanceof c.Readable){s(new m("Cannot follow redirect with body being a readable stream","unsupported-redirect")),y();return}(u.statusCode===303||(u.statusCode===301||u.statusCode===302)&&n.method==="POST")&&(b.method="GET",b.body=void 0,b.headers.delete("content-length")),r(G(new P(A,b))),y();return}}}u.once("end",()=>{i&&i.removeEventListener("abort",l)});let h=c.pipeline(u,new c.PassThrough,T=>{s(T)});process.version<"v12.10"&&u.on("aborted",l);let U={url:n.url,status:u.statusCode,statusText:u.statusMessage,headers:g,size:n.size,counter:n.counter,highWaterMark:n.highWaterMark},R=g.get("Content-Encoding");if(!n.compress||n.method==="HEAD"||R===null||u.statusCode===204||u.statusCode===304){f=new p(h,U),r(f);return}let fe={flush:v.Z_SYNC_FLUSH,finishFlush:v.Z_SYNC_FLUSH};if(R==="gzip"||R==="x-gzip"){h=c.pipeline(h,v.createGunzip(fe),T=>{s(T)}),f=new p(h,U),r(f);return}if(R==="deflate"||R==="x-deflate"){c.pipeline(u,new c.PassThrough,A=>{s(A)}).once("data",A=>{(A[0]&15)==8?h=c.pipeline(h,v.createInflate(),b=>{s(b)}):h=c.pipeline(h,v.createInflateRaw(),b=>{s(b)}),f=new p(h,U),r(f)});return}if(R==="br"){h=c.pipeline(h,v.createBrotliDecompress(),T=>{s(T)}),f=new p(h,U),r(f);return}f=new p(h,U),r(f)}),ve(L,n)})}B.AbortError=Z;B.FetchError=m;B.Headers=S;B.Request=P;B.Response=p;B.default=G;B.isRedirect=Y});var ue=me(ie()),Ie=(t,e)=>async r=>{let s={method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify({query:r})};return await ue.default(t,s)},Ne=t=>`mutation {
  createVisit(data: {
    ip: "${t.headers["client-ip"]}"
    userAgent: "${t.headers["user-agent"]}",
    created: "${new Date().toISOString()}",
    account: {
      connect: "${t.queryStringParameters.account}"
    }
  }) {
   _id
  }
}`;exports.handler=async t=>{let e=await Ie(process.env.GRAPHQL_URL,process.env.GRAPHQL_SECRET)(Ne(t));return{statusCode:e.status,body:e.ok?await e.text():e.statusText}};
