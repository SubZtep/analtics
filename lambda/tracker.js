var le=Object.create,D=Object.defineProperty,he=Object.getPrototypeOf,de=Object.prototype.hasOwnProperty,pe=Object.getOwnPropertyNames,ye=Object.getOwnPropertyDescriptor;var ge=t=>D(t,"__esModule",{value:!0});var G=(t,e)=>()=>(e||(e={exports:{}},t(e.exports,e)),e.exports);var me=(t,e,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of pe(e))!de.call(t,s)&&s!=="default"&&D(t,s,{get:()=>e[s],enumerable:!(r=ye(e,s))||r.enumerable});return t},we=t=>t&&t.__esModule?t:me(ge(D(t!=null?le(he(t)):{},"default",{value:t,enumerable:!0})),t);var _=G((qe,X)=>{"use strict";function be(t){if(!/^data:/i.test(t))throw new TypeError('`uri` does not appear to be a Data URI (must begin with "data:")');t=t.replace(/\r?\n/g,"");let e=t.indexOf(",");if(e===-1||e<=4)throw new TypeError("malformed data: URI");let r=t.substring(5,e).split(";"),s="",n=!1,o=r[0]||"text/plain",a=o;for(let l=1;l<r.length;l++)r[l]==="base64"?n=!0:(a+=`;${r[l]}`,r[l].indexOf("charset=")===0&&(s=r[l].substring(8)));!r[0]&&!s.length&&(a+=";charset=US-ASCII",s="US-ASCII");let i=n?"base64":"ascii",f=unescape(t.substring(e+1)),w=Buffer.from(f,i);return w.type=o,w.typeFull=a,w.charset=s,w}X.exports=be});var ee=G((De,j)=>{var{Readable:Se}=require("stream"),C=new WeakMap;async function*Te(t){for(let e of t)"stream"in e?yield*e.stream():yield e}var z=class{constructor(e=[],r={type:""}){let s=0,n=e.map(a=>{let i;return a instanceof Buffer?i=a:ArrayBuffer.isView(a)?i=Buffer.from(a.buffer,a.byteOffset,a.byteLength):a instanceof ArrayBuffer?i=Buffer.from(a):a instanceof z?i=a:i=Buffer.from(typeof a=="string"?a:String(a)),s+=i.length||i.size||0,i}),o=r.type===void 0?"":String(r.type).toLowerCase();C.set(this,{type:/[^\u0020-\u007E]/.test(o)?"":o,size:s,parts:n})}get size(){return C.get(this).size}get type(){return C.get(this).type}async text(){return Buffer.from(await this.arrayBuffer()).toString()}async arrayBuffer(){let e=new Uint8Array(this.size),r=0;for await(let s of this.stream())e.set(s,r),r+=s.length;return e.buffer}stream(){return Se.from(Te(C.get(this).parts))}slice(e=0,r=this.size,s=""){let{size:n}=this,o=e<0?Math.max(n+e,0):Math.min(e,n),a=r<0?Math.max(n+r,0):Math.min(r,n),i=Math.max(a-o,0),f=C.get(this).parts.values(),w=[],l=0;for(let y of f){let u=ArrayBuffer.isView(y)?y.byteLength:y.size;if(o&&u<=o)o-=u,a-=u;else{let g=y.slice(o,Math.min(u,a));if(w.push(g),l+=ArrayBuffer.isView(g)?g.byteLength:g.size,o=0,l>=i)break}}let A=new z([],{type:s});return Object.assign(C.get(A),{size:i,parts:w}),A}get[Symbol.toStringTag](){return"Blob"}static[Symbol.hasInstance](e){return typeof e=="object"&&typeof e.stream=="function"&&e.stream.length===0&&typeof e.constructor=="function"&&/^(Blob|File)$/.test(e[Symbol.toStringTag])}};Object.defineProperties(z.prototype,{size:{enumerable:!0},type:{enumerable:!0},slice:{enumerable:!0}});j.exports=z});var ie=G((B,te)=>{"use strict";B=te.exports=W;var k=require("http"),Be=require("https"),v=require("zlib"),c=require("stream"),$e=_(),H=require("util"),xe=ee(),Ae=require("crypto"),Ee=require("url"),I=class extends Error{constructor(e,r){super(e);Error.captureStackTrace(this,this.constructor),this.type=r}get name(){return this.constructor.name}get[Symbol.toStringTag](){return this.constructor.name}},m=class extends I{constructor(e,r,s){super(e,r);s&&(this.code=this.errno=s.code,this.erroredSysCall=s.syscall)}},F=Symbol.toStringTag,re=t=>typeof t=="object"&&typeof t.append=="function"&&typeof t.delete=="function"&&typeof t.get=="function"&&typeof t.getAll=="function"&&typeof t.has=="function"&&typeof t.set=="function"&&typeof t.sort=="function"&&t[F]==="URLSearchParams",P=t=>typeof t=="object"&&typeof t.arrayBuffer=="function"&&typeof t.type=="string"&&typeof t.stream=="function"&&typeof t.constructor=="function"&&/^(Blob|File)$/.test(t[F]);function K(t){return typeof t=="object"&&typeof t.append=="function"&&typeof t.set=="function"&&typeof t.get=="function"&&typeof t.getAll=="function"&&typeof t.delete=="function"&&typeof t.keys=="function"&&typeof t.values=="function"&&typeof t.entries=="function"&&typeof t.constructor=="function"&&t[F]==="FormData"}var Pe=t=>typeof t=="object"&&t[F]==="AbortSignal",O=`\r
`,J="-".repeat(2),Le=Buffer.byteLength(O),ne=t=>`${J}${t}${J}${O.repeat(2)}`;function se(t,e,r){let s="";return s+=`${J}${t}${O}`,s+=`Content-Disposition: form-data; name="${e}"`,P(r)&&(s+=`; filename="${r.name}"${O}`,s+=`Content-Type: ${r.type||"application/octet-stream"}`),`${s}${O.repeat(2)}`}var Re=()=>Ae.randomBytes(8).toString("hex");async function*Ce(t,e){for(let[r,s]of t)yield se(e,r,s),P(s)?yield*s.stream():yield s,yield O;yield ne(e)}function ze(t,e){let r=0;for(let[s,n]of t)r+=Buffer.byteLength(se(e,s,n)),P(n)?r+=n.size:r+=Buffer.byteLength(String(n)),r+=Le;return r+=Buffer.byteLength(ne(e)),r}var d=Symbol("Body internals"),N=class{constructor(e,{size:r=0}={}){let s=null;e===null?e=null:re(e)?e=Buffer.from(e.toString()):P(e)||Buffer.isBuffer(e)||(H.types.isAnyArrayBuffer(e)?e=Buffer.from(e):ArrayBuffer.isView(e)?e=Buffer.from(e.buffer,e.byteOffset,e.byteLength):e instanceof c||(K(e)?(s=`NodeFetchFormDataBoundary${Re()}`,e=c.Readable.from(Ce(e,s))):e=Buffer.from(String(e)))),this[d]={body:e,boundary:s,disturbed:!1,error:null},this.size=r,e instanceof c&&e.on("error",n=>{let o=n instanceof I?n:new m(`Invalid response body while trying to fetch ${this.url}: ${n.message}`,"system",n);this[d].error=o})}get body(){return this[d].body}get bodyUsed(){return this[d].disturbed}async arrayBuffer(){let{buffer:e,byteOffset:r,byteLength:s}=await M(this);return e.slice(r,r+s)}async blob(){let e=this.headers&&this.headers.get("content-type")||this[d].body&&this[d].body.type||"",r=await this.buffer();return new xe([r],{type:e})}async json(){let e=await M(this);return JSON.parse(e.toString())}async text(){return(await M(this)).toString()}buffer(){return M(this)}};Object.defineProperties(N.prototype,{body:{enumerable:!0},bodyUsed:{enumerable:!0},arrayBuffer:{enumerable:!0},blob:{enumerable:!0},json:{enumerable:!0},text:{enumerable:!0}});async function M(t){if(t[d].disturbed)throw new TypeError(`body used already for: ${t.url}`);if(t[d].disturbed=!0,t[d].error)throw t[d].error;let{body:e}=t;if(e===null)return Buffer.alloc(0);if(P(e)&&(e=e.stream()),Buffer.isBuffer(e))return e;if(!(e instanceof c))return Buffer.alloc(0);let r=[],s=0;try{for await(let n of e){if(t.size>0&&s+n.length>t.size){let o=new m(`content size at ${t.url} over limit: ${t.size}`,"max-size");throw e.destroy(o),o}s+=n.length,r.push(n)}}catch(n){throw n instanceof I?n:new m(`Invalid response body while trying to fetch ${t.url}: ${n.message}`,"system",n)}if(e.readableEnded===!0||e._readableState.ended===!0)try{return r.every(n=>typeof n=="string")?Buffer.from(r.join("")):Buffer.concat(r,s)}catch(n){throw new m(`Could not create Buffer from response body for ${t.url}: ${n.message}`,"system",n)}else throw new m(`Premature close of server response while trying to fetch ${t.url}`)}var oe=(t,e)=>{let r,s,{body:n}=t;if(t.bodyUsed)throw new Error("cannot clone body after it is used");return n instanceof c&&typeof n.getBoundary!="function"&&(r=new c.PassThrough({highWaterMark:e}),s=new c.PassThrough({highWaterMark:e}),n.pipe(r),n.pipe(s),t[d].body=r,n=s),n},ae=(t,e)=>t===null?null:typeof t=="string"?"text/plain;charset=UTF-8":re(t)?"application/x-www-form-urlencoded;charset=UTF-8":P(t)?t.type||null:Buffer.isBuffer(t)||H.types.isAnyArrayBuffer(t)||ArrayBuffer.isView(t)?null:t&&typeof t.getBoundary=="function"?`multipart/form-data;boundary=${t.getBoundary()}`:K(t)?`multipart/form-data; boundary=${e[d].boundary}`:t instanceof c?null:"text/plain;charset=UTF-8",ve=t=>{let{body:e}=t;return e===null?0:P(e)?e.size:Buffer.isBuffer(e)?e.length:e&&typeof e.getLengthSync=="function"?e.hasKnownLength&&e.hasKnownLength()?e.getLengthSync():null:K(e)?ze(t[d].boundary):null},Oe=(t,{body:e})=>{e===null?t.end():P(e)?e.stream().pipe(t):Buffer.isBuffer(e)?(t.write(e),t.end()):e.pipe(t)},V=typeof k.validateHeaderName=="function"?k.validateHeaderName:t=>{if(!/^[\^`\-\w!#$%&'*+.|~]+$/.test(t)){let e=new TypeError(`Header name must be a valid HTTP token [${t}]`);throw Object.defineProperty(e,"code",{value:"ERR_INVALID_HTTP_TOKEN"}),e}},Q=typeof k.validateHeaderValue=="function"?k.validateHeaderValue:(t,e)=>{if(/[^\t\u0020-\u007E\u0080-\u00FF]/.test(e)){let r=new TypeError(`Invalid character in header content ["${t}"]`);throw Object.defineProperty(r,"code",{value:"ERR_INVALID_CHAR"}),r}},S=class extends URLSearchParams{constructor(e){let r=[];if(e instanceof S){let s=e.raw();for(let[n,o]of Object.entries(s))r.push(...o.map(a=>[n,a]))}else if(e!=null)if(typeof e=="object"&&!H.types.isBoxedPrimitive(e)){let s=e[Symbol.iterator];if(s==null)r.push(...Object.entries(e));else{if(typeof s!="function")throw new TypeError("Header pairs must be iterable");r=[...e].map(n=>{if(typeof n!="object"||H.types.isBoxedPrimitive(n))throw new TypeError("Each header pair must be an iterable object");return[...n]}).map(n=>{if(n.length!==2)throw new TypeError("Each header pair must be a name/value tuple");return[...n]})}}else throw new TypeError("Failed to construct 'Headers': The provided value is not of type '(sequence<sequence<ByteString>> or record<ByteString, ByteString>)");return r=r.length>0?r.map(([s,n])=>(V(s),Q(s,String(n)),[String(s).toLowerCase(),String(n)])):void 0,super(r),new Proxy(this,{get(s,n,o){switch(n){case"append":case"set":return(a,i)=>(V(a),Q(a,String(i)),URLSearchParams.prototype[n].call(o,String(a).toLowerCase(),String(i)));case"delete":case"has":case"getAll":return a=>(V(a),URLSearchParams.prototype[n].call(o,String(a).toLowerCase()));case"keys":return()=>(s.sort(),new Set(URLSearchParams.prototype.keys.call(s)).keys());default:return Reflect.get(s,n,o)}}})}get[Symbol.toStringTag](){return this.constructor.name}toString(){return Object.prototype.toString.call(this)}get(e){let r=this.getAll(e);if(r.length===0)return null;let s=r.join(", ");return/^content-encoding$/i.test(e)&&(s=s.toLowerCase()),s}forEach(e){for(let r of this.keys())e(this.get(r),r)}*values(){for(let e of this.keys())yield this.get(e)}*entries(){for(let e of this.keys())yield[e,this.get(e)]}[Symbol.iterator](){return this.entries()}raw(){return[...this.keys()].reduce((e,r)=>(e[r]=this.getAll(r),e),{})}[Symbol.for("nodejs.util.inspect.custom")](){return[...this.keys()].reduce((e,r)=>{let s=this.getAll(r);return r==="host"?e[r]=s[0]:e[r]=s.length>1?s:s[0],e},{})}};Object.defineProperties(S.prototype,["get","entries","forEach","values"].reduce((t,e)=>(t[e]={enumerable:!0},t),{}));function Ue(t=[]){return new S(t.reduce((e,r,s,n)=>(s%2==0&&e.push(n.slice(s,s+2)),e),[]).filter(([e,r])=>{try{return V(e),Q(e,String(r)),!0}catch{return!1}}))}var ke=new Set([301,302,303,307,308]),Y=t=>ke.has(t),$=Symbol("Response internals"),p=class extends N{constructor(e=null,r={}){super(e,r);let s=r.status||200,n=new S(r.headers);if(e!==null&&!n.has("Content-Type")){let o=ae(e);o&&n.append("Content-Type",o)}this[$]={url:r.url,status:s,statusText:r.statusText||"",headers:n,counter:r.counter,highWaterMark:r.highWaterMark}}get url(){return this[$].url||""}get status(){return this[$].status}get ok(){return this[$].status>=200&&this[$].status<300}get redirected(){return this[$].counter>0}get statusText(){return this[$].statusText}get headers(){return this[$].headers}get highWaterMark(){return this[$].highWaterMark}clone(){return new p(oe(this,this.highWaterMark),{url:this.url,status:this.status,statusText:this.statusText,headers:this.headers,ok:this.ok,redirected:this.redirected,size:this.size})}static redirect(e,r=302){if(!Y(r))throw new RangeError('Failed to execute "redirect" on "response": Invalid status code');return new p(null,{headers:{location:new URL(e).toString()},status:r})}get[Symbol.toStringTag](){return"Response"}};Object.defineProperties(p.prototype,{url:{enumerable:!0},status:{enumerable:!0},ok:{enumerable:!0},redirected:{enumerable:!0},statusText:{enumerable:!0},headers:{enumerable:!0},clone:{enumerable:!0}});var Ie=t=>{if(t.search)return t.search;let e=t.href.length-1,r=t.hash||(t.href[e]==="#"?"#":"");return t.href[e-r.length]==="?"?"?":""},x=Symbol("Request internals"),q=t=>typeof t=="object"&&typeof t[x]=="object",L=class extends N{constructor(e,r={}){let s;q(e)?s=new URL(e.url):(s=new URL(e),e={});let n=r.method||e.method||"GET";if(n=n.toUpperCase(),(r.body!=null||q(e))&&e.body!==null&&(n==="GET"||n==="HEAD"))throw new TypeError("Request with GET/HEAD method cannot have body");let o=r.body?r.body:q(e)&&e.body!==null?oe(e):null;super(o,{size:r.size||e.size||0});let a=new S(r.headers||e.headers||{});if(o!==null&&!a.has("Content-Type")){let f=ae(o,this);f&&a.append("Content-Type",f)}let i=q(e)?e.signal:null;if("signal"in r&&(i=r.signal),i!==null&&!Pe(i))throw new TypeError("Expected signal to be an instanceof AbortSignal");this[x]={method:n,redirect:r.redirect||e.redirect||"follow",headers:a,parsedURL:s,signal:i},this.follow=r.follow===void 0?e.follow===void 0?20:e.follow:r.follow,this.compress=r.compress===void 0?e.compress===void 0?!0:e.compress:r.compress,this.counter=r.counter||e.counter||0,this.agent=r.agent||e.agent,this.highWaterMark=r.highWaterMark||e.highWaterMark||16384,this.insecureHTTPParser=r.insecureHTTPParser||e.insecureHTTPParser||!1}get method(){return this[x].method}get url(){return Ee.format(this[x].parsedURL)}get headers(){return this[x].headers}get redirect(){return this[x].redirect}get signal(){return this[x].signal}clone(){return new L(this)}get[Symbol.toStringTag](){return"Request"}};Object.defineProperties(L.prototype,{method:{enumerable:!0},url:{enumerable:!0},headers:{enumerable:!0},redirect:{enumerable:!0},clone:{enumerable:!0},signal:{enumerable:!0}});var He=t=>{let{parsedURL:e}=t[x],r=new S(t[x].headers);r.has("Accept")||r.set("Accept","*/*");let s=null;if(t.body===null&&/^(post|put)$/i.test(t.method)&&(s="0"),t.body!==null){let i=ve(t);typeof i=="number"&&!Number.isNaN(i)&&(s=String(i))}s&&r.set("Content-Length",s),r.has("User-Agent")||r.set("User-Agent","node-fetch"),t.compress&&!r.has("Accept-Encoding")&&r.set("Accept-Encoding","gzip,deflate,br");let{agent:n}=t;typeof n=="function"&&(n=n(e)),!r.has("Connection")&&!n&&r.set("Connection","close");let o=Ie(e);return{path:e.pathname+o,pathname:e.pathname,hostname:e.hostname,protocol:e.protocol,port:e.port,hash:e.hash,search:e.search,query:e.query,href:e.href,method:t.method,headers:r[Symbol.for("nodejs.util.inspect.custom")](),insecureHTTPParser:t.insecureHTTPParser,agent:n}},Z=class extends I{constructor(e,r="aborted"){super(e,r)}},Fe=new Set(["data:","http:","https:"]);async function W(t,e){return new Promise((r,s)=>{let n=new L(t,e),o=He(n);if(!Fe.has(o.protocol))throw new TypeError(`node-fetch cannot load ${t}. URL scheme "${o.protocol.replace(/:$/,"")}" is not supported.`);if(o.protocol==="data:"){let u=$e(n.url),g=new p(u,{headers:{"Content-Type":u.typeFull}});r(g);return}let a=(o.protocol==="https:"?Be:k).request,{signal:i}=n,f=null,w=()=>{let u=new Z("The operation was aborted.");s(u),n.body&&n.body instanceof c.Readable&&n.body.destroy(u),!(!f||!f.body)&&f.body.emit("error",u)};if(i&&i.aborted){w();return}let l=()=>{w(),y()},A=a(o);i&&i.addEventListener("abort",l);let y=()=>{A.abort(),i&&i.removeEventListener("abort",l)};A.on("error",u=>{s(new m(`request to ${n.url} failed, reason: ${u.message}`,"system",u)),y()}),A.on("response",u=>{A.setTimeout(0);let g=Ue(u.rawHeaders);if(Y(u.statusCode)){let T=g.get("Location"),E=T===null?null:new URL(T,n.url);switch(n.redirect){case"error":s(new m(`uri requested responds with a redirect, redirect mode is set to error: ${n.url}`,"no-redirect")),y();return;case"manual":if(E!==null)try{g.set("Location",E)}catch(b){s(b)}break;case"follow":{if(E===null)break;if(n.counter>=n.follow){s(new m(`maximum redirect reached at: ${n.url}`,"max-redirect")),y();return}let b={headers:new S(n.headers),follow:n.follow,counter:n.counter+1,agent:n.agent,compress:n.compress,method:n.method,body:n.body,signal:n.signal,size:n.size};if(u.statusCode!==303&&n.body&&e.body instanceof c.Readable){s(new m("Cannot follow redirect with body being a readable stream","unsupported-redirect")),y();return}(u.statusCode===303||(u.statusCode===301||u.statusCode===302)&&n.method==="POST")&&(b.method="GET",b.body=void 0,b.headers.delete("content-length")),r(W(new L(E,b))),y();return}}}u.once("end",()=>{i&&i.removeEventListener("abort",l)});let h=c.pipeline(u,new c.PassThrough,T=>{s(T)});process.version<"v12.10"&&u.on("aborted",l);let U={url:n.url,status:u.statusCode,statusText:u.statusMessage,headers:g,size:n.size,counter:n.counter,highWaterMark:n.highWaterMark},R=g.get("Content-Encoding");if(!n.compress||n.method==="HEAD"||R===null||u.statusCode===204||u.statusCode===304){f=new p(h,U),r(f);return}let ce={flush:v.Z_SYNC_FLUSH,finishFlush:v.Z_SYNC_FLUSH};if(R==="gzip"||R==="x-gzip"){h=c.pipeline(h,v.createGunzip(ce),T=>{s(T)}),f=new p(h,U),r(f);return}if(R==="deflate"||R==="x-deflate"){c.pipeline(u,new c.PassThrough,E=>{s(E)}).once("data",E=>{(E[0]&15)==8?h=c.pipeline(h,v.createInflate(),b=>{s(b)}):h=c.pipeline(h,v.createInflateRaw(),b=>{s(b)}),f=new p(h,U),r(f)});return}if(R==="br"){h=c.pipeline(h,v.createBrotliDecompress(),T=>{s(T)}),f=new p(h,U),r(f);return}f=new p(h,U),r(f)}),Oe(A,n)})}B.AbortError=Z;B.FetchError=m;B.Headers=S;B.Request=L;B.Response=p;B.default=W;B.isRedirect=Y});var ue=we(ie()),fe=(t,e)=>async r=>await ue.default(t,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify({query:r})});var Ne=({headers:t,queryStringParameters:e})=>{let r={account:`{connect:"${e.account}"}`};return t["client-ip"]&&(r.ip=`"${t["client-ip"]}"`),t["user-agent"]&&(r.userAgent=`"${t["user-agent"]}"`),e.referrer?r.referrer=`"${e.noscript}"`:t.referer&&(r.referrer=`"${t.referer}"`),e.location&&(r.location=`"${e.location}"`),e.noscript&&(r.noscript=e.noscript==="true"),r},Me=t=>`mutation {
  createVisit(data: {
    ${Object.entries(t).map(([e,r])=>`${e}:${r}`).join(",")},
    created: "${new Date().toISOString()}"
  }) {
   _id
  }
}`;exports.handler=async t=>{let e=await fe(process.env.GRAPHQL_URL,process.env.GRAPHQL_SECRET)(Me(Ne(t))),r={statusCode:e.status};return e.ok?(r.headers={"Content-Type":t.queryStringParameters.noscript?"text/html":"text/javascript","X-Content-Type-Options":"nosniff"},r.body=""):r.body=e.statusText,r};
